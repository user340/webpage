<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<title>e-yuuki.org</title>
</head>
<body><div class="tiny">
<h1>OSのインストールと初期設定</h1>
<hr>
<ol>
<li><a href="#intro">このページについて</a></li>
<li><a href="#install">NetBSDのインストール</a></li>
<li><a href="#network">ネットワーク接続</a></li>
<li><a href="#block">すべて遮断する</a></li>
<li><a href="#user">ユーザの作成</a></li>
<li><a href="#pkgsrc">pkgsrc(7)のインストール</a></li>
</ol>

<h2 id="intro">このページについて</h2>
<p>ここではなんらかの環境（ノートPC・デスクトップPCのような物理的なものやVirtualBox・KVM・Bhyve・Xenなどの仮想マシン）にNetBSDをインストールし、日本語デスクトップ環境をインストールする前段階について説明します。したがって内容はNetBSDに強く依存してしまいますが、手順そのものはほとんどのUnix系OSに通じると思われます。NetBSD以外のOSをインストールしたい場合、NetBSD以外のBSD Unixであれば<a href="#pkgsrc">pkgsrc(7)のインストール</a>を読み飛ばしてもらい、GNU/Linuxであればインストーラの時点でほぼすべての手順が完了していると思うので<a href="#block">すべて遮断する</a>だけを読んでもらえればいいです（ただしSlackware系のディストリビューションは除く。しかしこれを選んだのであればこの文書自体読む必要はないでしょう）。</p>

<h2 id="install">NetBSDのインストール</h2>
<p>多くの場合amd64（64bit）アーキテクチャのインストーラをFTPサーバからダウンロードしてそれをブートすることになります。http://nycdn.netbsd.org/pub/NetBSD-daily/netbsd-8/latest/images/ からISOファイルやgzip圧縮されたimgファイルをダウンロードできます。</p>

<p>多くのIT技術系ブログでNetBSDのインストール手順について画像つきで詳しく解説されています。しかし僕はThe NetBSD Projectから提供されている<a href="https://www.netbsd.org/docs/guide/en/chap-exinst.html">Chapter 3. Example Installation</a>を読むことをおすすめします。これがあるのでインストール手順についてあらためて紙面を割く必要もありません。この文書は英語ですが、どのみちNetBSDのインストーラも英語なので気にしなくて結構です。</p>

<p>仮想マシンにNetBSDをインストールするのであれば、<a href="https://legacyos.ichmy.0t0.jp/netbsd/">NetBSDで遊ぼうのこーな</a>を参考に仮想化ソフトウェアを選ぶといいでしょう。このページから引用し、さらに僕が普段使っているBhyveや使ったことのあるXenも加えると次のようになります。</p>

<table><thead><tr>
<th>ソフトウェア</th>
<th>Addin</th>
<th>状況</th>
</tr></thead>
<tbody>
<tr>
<td>VirtualBox</td>
<td>x</td>
<td>GuestAdditionsは未対応だが他問題なし</td>
</tr>
<tr>
<td>VMware</td>
<td>o</td>
<td>非ネット共有フォルダに失敗</td>
</tr>
<tr>
<td>クライアントHyper-V</td>
<td>x</td>
<td>SMPとACPIを無効化しないとネット不可。ネットはレガシーアダプタ要</td>
</tr>
<tr>
<td>QEMU</td>
<td>x</td>
<td>起動に失敗</td>
</tr>
<tr>
<td>Bhyve</td>
<td>?</td>
<td>vm-bhyveで確認。</td>
</tr>
<tr>
<td>Xen</td>
<td>?</td>
<td>Domain 0はNetBSD</td>
</tr></tbody></table>

<p>物理的な環境にインストールする場合、まずは動作が確認されている機器を慎重に選ぶところから始まります。ThinkPadはだいたい動くようです。僕が使ってきたマシンについては<a href="../netbsd/thinkpad.html">NetBSD on ThinkPad</a>を参照してください。</p>

<h2 id="network">ネットワーク接続</h2>
<p><code>ifconfig(8)</code>でネットワークインタフェースの名前を確認します。有線接続する場合はmedia: Ethernet autoselect、無線接続する場合はmedia: IEEE802.11となっているネットワークインタフェースを探します。</p>

<pre><code># ifconfig
wm0: flags=0x8802&lt;BROADCAST,SIMPLEX,MULTICAST&gt; mtu 1500
        capabilities=7ff80&lt;TSO4,IP4CSUM_Rx,IP4CSUM_Tx,TCP4CSUM_Rx&gt;
        capabilities=7ff80&lt;TCP4CSUM_Tx,UDP4CSUM_Rx,UDP4CSUM_Tx,TCP6CSUM_Rx&gt;
        capabilities=7ff80&lt;TCP6CSUM_Tx,UDP6CSUM_Rx,UDP6CSUM_Tx,TSO6&gt;
        enabled=0
        ec_capabilities=7&lt;VLAN_MTU,VLAN_HWTAGGING,JUMBO_MTU&gt;
        ec_enabled=0
        address: 4d:a8:1f:24:ab:03
        media: Ethernet autoselect (none)
        status: no carrier
iwn0: flags=0x8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; mtu 1500
        ssid SSID nwkey *****
        powersave off
        bssid 6d:d4:18:01:a6:14 chan 10
        address: 7d:99:25:7a:23:c9
        media: IEEE802.11 autoselect (OFDM36 mode 11g)
        status: active
        inet 192.168.100.102/24 broadcast 192.168.100.255 flags 0x0
        inet6 fe80::629b:d0c1:135b:eb24%iwn0/64 flags 0x0 scopeid 0x2
        inet6 2001:268:c146:5657:63c1:78ae:4457:e5ae/64 flags 0x0
lo0: flags=0x8049&lt;UP,LOOPBACK,RUNNING,MULTICAST&gt; mtu 33624
        inet 127.0.0.1/8 flags 0x0
        inet6 ::1/128 flags 0x20&lt;NODAD&gt;
        inet6 fe80::1%lo0/64 flags 0x0 scopeid 0x3</code></pre>

<p>この出力は既に無線接続が設定されているものですが、ここで有線接続のネットワークインタフェースはwm0、無線ではiwn0ということがmediaの行から分かります。</p>

<p>ネットワークの設定後はnetworkデーモンを再起動します。</p>

<pre><code># service network restart</code></pre>

<h3>有線接続（固定IPアドレス）</h3>
<p>あらかじめどのIPアドレスを使うか定められており有線接続する場合、<code>ifconfig.if(5)</code>を書きます。IPアドレスが192.168.200.40/24でネットワークインタフェースがwm0のとき/etc/ifconfig.wm0を次のように編集します。</p>

<pre><code>inet 192.168.200.40 netmask 255.255.255.0</code></pre>

<h3>有線接続（動的IPアドレス）</h3>
<p>DHCPサーバに問い合わせてIPアドレスを動的に割り振るネットワーク環境の場合<code>dhcpcd(8)</code>を使うだけで済みます。ネットワークインタフェースがwm0だとすると次のように実行します。</p>

<pre><code># dhcpcd wm0</code></pre>

<p>OS起動時に自動的に<code>dhcpcd(8)</code>を実行するには/etc/rc.confに次の2行を追記します。</p>

<pre><code>dhcpcd=YES
dhcpcd_flags="wm0"</code></pre>

<h3>無線接続（動的IPアドレス）</h3>
<p>無線を使うには次の手順に従います。</p>

<ol>
  <li>SSIDとパスフレーズ（パスワード）の確認</li>
  <li><code>wpa_passphrase(8)</code>の実行</li>
  <li><code>wpa_supplicant(8)</code>の実行</li>
  <li><code>dhcpcd(8)</code>の実行</li>
</ol>

<p>まず無線接続に必要なSSIDとパスフレーズを控えます。ここではSSIDを<i>home-ssid</i>、パスフレーズを<i>password</i>、ネットワークインタフェースはiwm0とします。</p>

<p><code>wpa_passphrase ssid passphrase</code>という形式で<code>wpa_passphrase(8)</code>を実行します。</p>

<pre><code># wpa_passphrase home-ssid password
network={
        ssid="home-ssid"
        #psk="password"
        psk=d5264ac3e0512b34b5f6856bbb224b87ce84256de9023decb076ff974fbe06a2
}</code></pre>

<p>このコマンドで得られた出力を/etc/wpa_supplicant.confに書き込みます。</p>

<pre><code># wpa_passphrase home-ssid password &gt;&gt; /etc/wpa_supplicant.conf</code></pre>

<p><code>wpa_supplicant(8)</code>を実行します。</p>

<pre><code># wpa_supplicant -B -i iwn0 -c /etc/wpa_supplicant.conf</code></pre>

<p>無線のランプが光るなど無線デバイスが使えるようになったら、<code>dhcpcd(8)</code>でIPアドレスを取得してください。</p>

<pre><code># dhcpcd iwn0</code></pre>

<p>OS起動時にこれらの手順を自動でおこなうには/etc/rc.confに以下を追記します。</p>

<pre><code>wpa_supplicant=YES
wpa_supplicant_flags="-B -i iwn0 -c /etc/wpa_supplicant.conf"
dhcpcd=YES
dhcpcd_flags="iwm0"</code></pre>

<h2 id="block">すべて遮断する</h2>
<p>ネットワーク接続をしたあとはすぐに外からのあらゆるアクセスを遮断します。アクセスさせたいプロトコルやポート番号のみを開け、ユーザ認証が必要な場合はなるべくパスワード認証を避け公開鍵認証方式に切り替えます。どうしてもパスワード認証を使わざるを得ないときはパスワード生成ソフトウェアを通じて可能な限り長くランダムなパスワードを使ってください。</p>

<p>自宅で使うPCに対してこのポリシーは意味がないようにみえますが、これを習慣づけておくといざインターネットに公開するサーバを運用するとき役に立ちます。HTTPサーバを運用するだけでも、ありもしないwp-login.phpにアクセスしようとしたりrootでSSHログインを試みたりした痕跡がログにつくものです。自衛のために日頃から訓練しておくべきです。</p>

<p>アクセス制御にはlibwrapによるものと<code>npf(7)</code>によるものがあります。ここでは前者について説明します。</p>

<h3>libwrapによるTCPアクセス制御</h3>

<p>NetBSDでTCPアクセス制御を実現するには<code>inetd(8)</code>のlibwrapを設定します。設定ファイルは<code>hosts.allow(5)</code>と<code>hosts.deny(5)</code>の2つです。</p>

<p>はじめに/etc/hosts.denyを次のように書きます。</p>

<pre><code>ALL: ALL</code></pre>

<p>そして必要に応じて/etc/hosts.allowを編集します。<code>hosts.deny(5)</code>のルールが優先されるため、<code>hosts.deny(5)</code>で全て遮断したあとは<code>hosts.allow(5)</code>に書いてあるルールだけが通るようになります。たとえばSSHを通したい場合、次のようにします。</p>

<pre><code>sshd: ALL</code></pre>

<p>自宅や職場のローカルネットワークの場合、たとえばこのようにすれば十分でしょう。</p>

<pre><code>sshd: LOCAL</code></pre>

<p>サーバを外部に公開している場合<code>traceroute(8)</code>でプロバイダのドメインを調べてそこからのみアクセスできるようにします。</p>

<p><code>traceroute(8)</code>は次のように使います。</p>

<pre><code># traceroute www.google.com</code></pre>

<p>出力の中ではauやKDDI、ソフトバンクのようなプロバイダの名前が確認できるはずです。/etc/hosts.allowにそれを指定します。</p>

<pre><code>sshd: .au-net.ne.jp</code></pre>

<p>設定後は許可したネットワーク以外からはアクセスできないことを確認してください。たとえ公開用のサーバで設定が失敗してSSHログインできなくても、Webのコンソールからいつでも操作できるので問題ありません。</p>

<h2 id="user">ユーザの作成</h2>
<p>特権を持ったユーザで常にシステムにログインして作業し続けるのは一見快適かもしれません。が、操作ミスで消してはいけないファイルを誤って消す／編集してしまう危険を常に抱えることでもあります。また一般的に、SSHであっても直接rootユーザでログインするのは避けられる傾向にあります。</p>

<p>そこで普段は特権を持たない一般ユーザを作り、それでログインしてなんらかの作業をおこないます。ソフトウェアのインストールや設定ファイルの編集などで権限が必要になったときだけ<code>su(1)</code>でrootユーザになるポリシーとします。</p>

<p>ユーザの追加には<code>useradd(8)</code>を使います。作成予定のユーザ名をjohnとすると次のように実行します。NetBSDの<code>useradd(8)</code>では<code>-m</code>オプションを付けないとホームディレクトリが作られないことに注意してください。</p>

<pre><code># useradd -m john</code></pre>

<p>パスワードは<code>passwd(1)</code>にユーザ名を渡して実行します。johnに設定するパスワードを2回尋ねられます。入力した文字は画面に印字されません（「エコーされない」とも言います）。</p>

<pre><code># passwd john</code></pre>

<p><code>su(1)</code>でrootユーザになるにはwheelグループにユーザを追加します。/etc/groupを編集します。wheelの行にカンマ区切りでユーザ名を追記してください。</p>

<pre><code>wheel:*:0:root,john</code></pre>

<h2 id="pkgsrc">pkgsrc(7)のインストール</h2>
<p>NetBSDでは第三者製ソフトウェアパッケージのビルドとインストールに<code>pkgsrc(7)</code>というビルドシステムを使います。</p>

<p><code>pkgsrc(7)</code>のtarballをダウンロードします。NetBSDのFTPサーバだけでなく、国内の大学や企業が運営しているFTPサーバからもダウンロードできるでしょう。たとえばftp.iij.ad.jpやftp.jaist.ac.jpです。ダウンロードしたtarballを/usrの下に展開するだけでNetBSDでの<code>pkgsrc(7)</code>のインストールは終わりです。</p>

<pre><code># ftp ftp://ftp.iij.ad.jp/pub/pkgsrc/stable/pkgsrc.tar.gz
# tar zxf pkgsrc.tar.gz -C /usr
# cd /usr/pkgsrc</code></pre>

<p><code>pkgsrc(7)</code>はstable版とcurrent版の2種類を選ぶことができます。stable版は3か月に一度更新される安定版で、current版は不安定な開発版です。しかし一番新しいFirefoxを使いたいときなど、最新のバージョンのソフトウェアを使いたい場合は後者を選ばざるを得ません。とりあえずここではstable版で話を進めますが、用途に応じてどちらを選ぶか考えてください。</p>

<hr>
<footer>
<div style="text-align:center;padding-top:2em;padding-bottom:2em;"><a rel="license" href="https://creativecommons.org/publicdomain/zero/1.0/"><img src="https://i.creativecommons.org/p/zero/1.0/88x31.png" alt="CC0" /></a></div>
<p>To the extent possible under law, <a href="mailto:uki@e-yuuki.org">Yuuki Enomoto</a> has waived all copyright and related or neighboring rights to e-yuuki.org. This work is published from: Japan.</p>
</footer>
</div></body>
</html>

